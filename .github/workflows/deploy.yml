name: Deploy Backend to cPanel

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FTP_DIR: "public_html/myapp/"
  FTP_PORT: "21"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benzflex.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ""

      - name: Debug FTP Secrets (Preview)
        env:
          FTP_SERVER: ftp.benzflex.com
          FTP_USERNAME: turtlvhi
          FTP_PASSWORD: America@1234567890
        run: |
          echo "=========================================="
          echo "üîç Debug: FTP Secrets Preview (Before Verification)"
          echo "=========================================="
          echo ""
          if [ -z "$FTP_SERVER" ]; then
            echo "‚ùå FTP_SERVER: NOT SET or EMPTY"
          else
            SERVER_LEN=${#FTP_SERVER}
            echo "‚úÖ FTP_SERVER: Set"
            echo "   Length: $SERVER_LEN characters"
            echo "   Preview: ${FTP_SERVER:0:15}..."
            echo "   Full value: $FTP_SERVER"
          fi
          echo ""
          if [ -z "$FTP_USERNAME" ]; then
            echo "‚ùå FTP_USERNAME: NOT SET or EMPTY"
          else
            USERNAME_LEN=${#FTP_USERNAME}
            echo "‚úÖ FTP_USERNAME: Set"
            echo "   Length: $USERNAME_LEN characters"
            echo "   Preview: ${FTP_USERNAME:0:10}..."
            echo "   Full value: $FTP_USERNAME"
          fi
          echo ""
          if [ -z "$FTP_PASSWORD" ]; then
            echo "‚ùå FTP_PASSWORD: NOT SET or EMPTY"
          else
            PASSWORD_LEN=${#FTP_PASSWORD}
            echo "‚úÖ FTP_PASSWORD: Set"
            echo "   Length: $PASSWORD_LEN characters"
            echo "   Preview: ${FTP_PASSWORD:0:5}*** (first 5 chars shown)"
            echo "   Full value: $FTP_PASSWORD"
          fi
          echo ""
          echo "=========================================="
          echo ""

      - name: Verify FTP Secrets
        id: verify-secrets
        env:
          FTP_SERVER: ftp.benzflex.com
          FTP_USERNAME: turtlvhi
          FTP_PASSWORD: America@1234567890
        run: |
          set -e
          echo "=========================================="
          echo "üîê Verifying FTP Secrets"
          echo "=========================================="
          
          # Check each secret individually with detailed error messages
          MISSING_SECRETS=0
          
          if [ -z "$FTP_SERVER" ]; then
            echo "::error::‚ùå FTP_SERVER secret is missing or empty!"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            SERVER_LEN=${#FTP_SERVER}
            echo "‚úÖ FTP_SERVER: Set (length: $SERVER_LEN chars)"
            # Show first few characters for verification (safe - doesn't expose full value)
            echo "   Preview: ${FTP_SERVER:0:10}..."
          fi
          
          if [ -z "$FTP_USERNAME" ]; then
            echo "::error::‚ùå FTP_USERNAME secret is missing or empty!"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            USERNAME_LEN=${#FTP_USERNAME}
            echo "‚úÖ FTP_USERNAME: Set (length: $USERNAME_LEN chars)"
            echo "   Preview: ${FTP_USERNAME:0:5}..."
          fi
          
          if [ -z "$FTP_PASSWORD" ]; then
            echo "::error::‚ùå FTP_PASSWORD secret is missing or empty!"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            PASSWORD_LEN=${#FTP_PASSWORD}
            echo "‚úÖ FTP_PASSWORD: Set (length: $PASSWORD_LEN chars)"
            echo "   Preview: *** (hidden for security)"
          fi
          
          echo "=========================================="
          
          if [ $MISSING_SECRETS -gt 0 ]; then
            echo "::error::‚ùå Missing $MISSING_SECRETS required FTP secret(s)!"
            echo ""
            echo "üìã TROUBLESHOOTING GUIDE:"
            echo "1. Go to: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Verify these secrets exist:"
            echo "   - FTP_SERVER (e.g., ftp.yourdomain.com)"
            echo "   - FTP_USERNAME (your FTP username)"
            echo "   - FTP_PASSWORD (your FTP password)"
            echo "3. If using environment protection:"
            echo "   - Check: Settings ‚Üí Environments ‚Üí production ‚Üí Secrets"
            echo "   - Ensure secrets are added to the 'production' environment"
            echo "4. After adding secrets, re-run this workflow"
            echo ""
            exit 1
          fi
          
          # Set environment variables for use in subsequent steps
          echo "FTP_SERVER=$FTP_SERVER" >> $GITHUB_ENV
          echo "FTP_USERNAME=$FTP_USERNAME" >> $GITHUB_ENV
          echo "FTP_PASSWORD=$FTP_PASSWORD" >> $GITHUB_ENV
          echo "FTP_DIR=${{ env.FTP_DIR }}" >> $GITHUB_ENV
          echo "FTP_PORT=${{ env.FTP_PORT }}" >> $GITHUB_ENV
          
          echo "‚úÖ All FTP secrets verified and set as environment variables"
          echo "=========================================="

      - name: Prepare deployment package
        working-directory: backend
        run: |
          set -e
          echo "Preparing minimal deployment package..."
          rm -rf deployment && mkdir -p deployment
          rsync -av --exclude='node_modules' --exclude='.git' --exclude='.github' --exclude='test' --exclude='tests' --exclude='*.test.js' --exclude='*.spec.js' --exclude='logs' --exclude='*.log' --exclude='*.md' --exclude='**/*.md' --exclude='config.env' --exclude='*.env' --exclude='.env*' --exclude='tmp' --exclude='temp' --exclude='deployment' --exclude='production-archive' --exclude='production-package' --exclude='test-*.js' --exclude='quick-*.js' --exclude='monitor-*.js' --exclude='run-*.js' --exclude='check-*.js' --exclude='analyze-*.js' --exclude='cpanel-diagnose.sh' --exclude='create-production-archive.sh' --exclude='*.zip' --exclude='*.tar.gz' --exclude='.gitignore' --exclude='.DS_Store' --exclude='*.swp' --exclude='*.swo' --exclude='.vscode' --exclude='.idea' --exclude='coverage' --exclude='.nyc_output' --exclude='scripts' ./ ./deployment/
          cp start.sh deployment/start.sh && chmod +x deployment/start.sh
          echo "üì¶ Deployment package size: $(du -sh deployment | cut -f1)"
          echo "‚úÖ Critical files verified"

      - name: Deploy via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        env:
          # Pass secrets directly to the action (more reliable than env vars)
          FTP_SERVER: ftp.benzflex.com
          FTP_USERNAME: turtlvhi
          FTP_PASSWORD: America@1234567890
        with:
          FTP_SERVER: ftp.benzflex.com
          FTP_USERNAME: turtlvhi
          FTP_PASSWORD: America@1234567890
          port: ${{ env.FTP_PORT }}
          local-dir: /deployment/
          server-dir: ${{ env.FTP_DIR }}
          exclude: |
            node_modules/**
            .git/**
            .github/**
            test/**
            tests/**
            *.test.js
            *.spec.js
            logs/**
            *.log
            *.md
            **/*.md
            config.env
            *.env
            .env*
            tmp/**
            temp/**
            deployment/**
            production-archive/**
            production-package/**
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            check-*.js
            analyze-*.js
            cpanel-diagnose.sh
            create-production-archive.sh
            *.zip
            *.tar.gz
            .gitignore
            .DS_Store
            scripts/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 120000
          dry-run: false

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "üåê Application deployed to: ${{ env.FTP_DIR }}"
          echo "üîó Live URL: https://benzflex.com"
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo "1. Install Dependencies (on server): cd ${{ env.FTP_DIR }} && npm install --production --legacy-peer-deps"
          echo "2. Set Environment Variables (in cPanel)"
          echo "3. Set Startup File (in cPanel): start.sh"
          echo "4. Set File Permissions (in cPanel File Manager): start.sh to 755"
          echo "5. Restart Node.js App"
          echo "6. Verify Deployment: Check logs for 'Memory limit is correctly set' and 'Server running'"

      - name: Error Analysis
        if: always()
        run: |
          echo "üîç DEPLOYMENT STATUS ANALYSIS"
          echo "üìä Step Status:"
          echo "  Deploy via FTP: ${{ steps.ftp-deploy.outcome }}"
          if [ "${{ job.status }}" != "success" ]; then
            echo "‚ùå DEPLOYMENT FAILED"
            if [ "${{ steps.ftp-deploy.outcome }}" == "failure" ]; then
              echo "‚ùå FAILED: Deploy via FTP"
              echo "üî¥ CHECK FOR DISK FULL ERROR (552) IN LOGS ABOVE"
              echo "IMMEDIATE ACTIONS REQUIRED:"
              echo "1. Clean up server disk space: Delete logs/, tmp/, node_modules/, old archives in ${{ env.FTP_DIR }}"
              echo "2. Check disk usage: cPanel ‚Üí Disk Usage"
              echo "3. After cleanup, retry deployment: GitHub Actions ‚Üí Re-run workflow"
              echo "Other common causes: FTP connection refused, Authentication failed, Directory not found, Network timeout"
            else
              echo "‚ùå FAILED: Earlier step (Setup/Preparation)"
              echo "Check logs above to identify the failing step"
            fi
          else
            echo "‚úÖ All steps completed successfully!"
          fi
