name: üöÄ Deploy Backend to cPanel

# Workflow triggers
on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: üéâ Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benzflex.com

    steps:
      # ========================================
      # Step 1: Checkout Code
      # ========================================
      - name: üöö Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ========================================
      # Step 2: Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      # ========================================
      # Step 3: Verify FTP Secrets
      # ========================================
      - name: üîç Verify FTP Secrets
        id: verify-secrets
        run: |
          echo "=== Verifying FTP Secrets ==="
          
          FTP_SERVER="${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}"
          FTP_USERNAME="${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}"
          FTP_PASSWORD="${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}"
          FTP_DIR="${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/backend' }}"
          FTP_PORT="${{ secrets.CPANEL_FTP_PORT || '21' }}"
          
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::Missing required FTP secrets!"
            echo ""
            echo "Required GitHub Secrets:"
            echo "  - CPANEL_FTP_SERVER (or FTP_SERVER)"
            echo "  - CPANEL_FTP_USER (or FTP_USERNAME)"
            echo "  - CPANEL_FTP_PASS (or FTP_PASSWORD)"
            echo ""
            echo "Optional Secrets:"
            echo "  - CPANEL_FTP_DIR (default: public_html/myapp/backend)"
            echo "  - CPANEL_FTP_PORT (default: 21)"
            exit 1
          fi
          
          echo "‚úÖ FTP secrets verified"
          echo "FTP_SERVER: ${FTP_SERVER:0:15}..."
          echo "FTP_USERNAME: ${FTP_USERNAME:0:10}..."
          echo "FTP_DIR: $FTP_DIR"
          echo "FTP_PORT: $FTP_PORT"
          
          # Export for later steps
          echo "FTP_SERVER=$FTP_SERVER" >> $GITHUB_ENV
          echo "FTP_USERNAME=$FTP_USERNAME" >> $GITHUB_ENV
          echo "FTP_PASSWORD=$FTP_PASSWORD" >> $GITHUB_ENV
          echo "FTP_DIR=$FTP_DIR" >> $GITHUB_ENV
          echo "FTP_PORT=$FTP_PORT" >> $GITHUB_ENV

      # ========================================
      # Step 4: Navigate to Backend Directory
      # ========================================
      - name: üìÅ Navigate to backend
        run: |
          cd backend
          echo "Current directory: $(pwd)"
          echo "Backend files:"
          ls -la | head -20
          echo "BACKEND_DIR=$(pwd)" >> $GITHUB_ENV

      # ========================================
      # Step 5: Install Dependencies (for scripts)
      # ========================================
      - name: üì¶ Install dependencies for scripts
        working-directory: backend
        run: |
          echo "Installing basic-ftp for pre-deployment checks..."
          npm install basic-ftp --no-save --legacy-peer-deps
          echo "‚úÖ Dependencies installed"

      # ========================================
      # Step 6: Check Remote Disk Space
      # ========================================
      - name: üíæ Check remote disk space
        id: check-disk-space
        working-directory: backend
        run: |
          echo "Checking remote server disk space..."
          node .github/scripts/checkDiskSpace.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}

      # ========================================
      # Step 7: Verify Remote Directories
      # ========================================
      - name: üß± Verify remote directories
        id: verify-dirs
        working-directory: backend
        run: |
          echo "Verifying remote FTP directories..."
          node .github/scripts/checkFtpDirs.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}

      # ========================================
      # Step 8: Prepare Deployment Package (Minimal Size)
      # ========================================
      - name: üßπ Prepare deployment package (minimal size)
        working-directory: backend
        run: |
          echo "Preparing minimal deployment package..."
          echo "This step minimizes package size to reduce disk space requirements"
          echo ""
          
          # Create deployment directory
          rm -rf deployment
          mkdir -p deployment
          
          # Calculate initial size
          INITIAL_SIZE=$(du -sh . | cut -f1)
          echo "üì¶ Initial directory size: $INITIAL_SIZE"
          echo ""
          
          # Copy files with exclusions using rsync
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='test' \
            --exclude='tests' \
            --exclude='*.test.js' \
            --exclude='*.spec.js' \
            --exclude='logs' \
            --exclude='*.log' \
            --exclude='*.md' \
            --exclude='**/*.md' \
            --exclude='config.env' \
            --exclude='*.env' \
            --exclude='.env*' \
            --exclude='tmp' \
            --exclude='temp' \
            --exclude='deployment' \
            --exclude='production-archive' \
            --exclude='production-package' \
            --exclude='test-*.js' \
            --exclude='quick-*.js' \
            --exclude='monitor-*.js' \
            --exclude='run-*.js' \
            --exclude='check-*.js' \
            --exclude='analyze-*.js' \
            --exclude='cpanel-diagnose.sh' \
            --exclude='create-production-archive.sh' \
            --exclude='*.zip' \
            --exclude='*.tar.gz' \
            --exclude='.gitignore' \
            --exclude='.DS_Store' \
            --exclude='*.swp' \
            --exclude='*.swo' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='coverage' \
            --exclude='.nyc_output' \
            --exclude='scripts' \
            ./ ./deployment/
          
          # CRITICAL: Ensure start.sh is included and executable
          if [ -f "start.sh" ]; then
            cp start.sh deployment/start.sh
            chmod +x deployment/start.sh
            echo "‚úÖ start.sh included and made executable"
          else
            echo "‚ùå ERROR: start.sh not found!"
            exit 1
          fi
          
          # Calculate deployment size
          DEPLOY_SIZE=$(du -sh deployment | cut -f1)
          DEPLOY_SIZE_BYTES=$(du -sb deployment | cut -f1)
          DEPLOY_SIZE_MB=$(echo "scale=2; $DEPLOY_SIZE_BYTES / 1024 / 1024" | bc)
          
          echo ""
          echo "üì¶ Deployment package size: $DEPLOY_SIZE (~${DEPLOY_SIZE_MB}MB)"
          echo ""
          
          # Warn if package is too large
          if (( $(echo "$DEPLOY_SIZE_MB > 50" | bc -l) )); then
            echo "‚ö†Ô∏è  WARNING: Deployment package is large (${DEPLOY_SIZE_MB}MB)"
            echo "   This may cause disk space issues on the server"
            echo "   Consider cleaning up server disk space before deployment"
          else
            echo "‚úÖ Deployment package size is reasonable (${DEPLOY_SIZE_MB}MB)"
          fi
          
          # Verify critical files
          echo ""
          echo "‚úÖ Verifying critical files:"
          CRITICAL_FILES=(
            "server.js"
            "app.js"
            "package.json"
            "start.sh"
            "services/stripeClient.js"
            "services/cloudinaryClient.js"
            "services/sendGridClient.js"
            "middleware/bookingUpload.js"
          )
          
          ALL_OK=true
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "deployment/$file" ]; then
              echo "  ‚úÖ $file"
            else
              echo "  ‚ùå $file MISSING!"
              ALL_OK=false
            fi
          done
          
          if [ "$ALL_OK" = false ]; then
            echo ""
            echo "‚ùå ERROR: Critical files are missing from deployment package!"
            exit 1
          fi
          
          # Verify directories
          echo ""
          echo "‚úÖ Verifying directories:"
          DIRS=("controllers" "routes" "models" "services" "utils" "middleware" "socket")
          for dir in "${DIRS[@]}"; do
            if [ -d "deployment/$dir" ]; then
              echo "  ‚úÖ $dir/"
            else
              echo "  ‚ùå $dir/ MISSING!"
              exit 1
            fi
          done
          
          echo ""
          echo "‚úÖ Deployment package ready!"

      # ========================================
      # Step 9: Deploy via FTP
      # ========================================
      - name: üì§ Deploy to cPanel via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT }}
          local-dir: backend/deployment/
          server-dir: ${{ env.FTP_DIR }}
          exclude: |
            node_modules/**
            .git/**
            .github/**
            test/**
            tests/**
            *.test.js
            *.spec.js
            logs/**
            *.log
            *.md
            **/*.md
            config.env
            *.env
            .env*
            tmp/**
            temp/**
            deployment/**
            production-archive/**
            production-package/**
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            check-*.js
            analyze-*.js
            cpanel-diagnose.sh
            create-production-archive.sh
            *.zip
            *.tar.gz
            .gitignore
            .DS_Store
            scripts/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 120000
          dry-run: false

      # ========================================
      # Step 10: Post-Deployment Summary
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo ""
          echo "üéâ ========================================"
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "üéâ ========================================"
          echo ""
          echo "üåê Application deployed to: ${{ env.FTP_DIR }}"
          echo "üîó Live URL: https://benzflex.com"
          echo ""
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo ""
          echo "1. ‚úÖ Install Dependencies (on server):"
          echo "   cd ~/public_html/myapp/backend"
          echo "   npm install --production --legacy-peer-deps"
          echo ""
          echo "2. ‚úÖ Set Environment Variables (in cPanel):"
          echo "   - Go to: cPanel ‚Üí Node.js App ‚Üí Your App"
          echo "   - Add/Update environment variables:"
          echo "     ‚Ä¢ STRIPE_SECRET_KEY"
          echo "     ‚Ä¢ CLOUDINARY_CLOUD_NAME"
          echo "     ‚Ä¢ CLOUDINARY_API_KEY"
          echo "     ‚Ä¢ CLOUDINARY_API_SECRET"
          echo "     ‚Ä¢ SENDGRID_API_KEY"
          echo "     ‚Ä¢ NODE_OPTIONS=--max-old-space-size=2048 --expose-gc"
          echo "     ‚Ä¢ DEBUG_KEY"
          echo "     ‚Ä¢ (All other required env vars)"
          echo ""
          echo "3. ‚úÖ Set Startup File (in cPanel):"
          echo "   - Go to: cPanel ‚Üí Node.js App ‚Üí Your App"
          echo "   - Set 'Startup File' to: start.sh"
          echo "   - OR: backend/start.sh (if path is relative to app root)"
          echo ""
          echo "4. ‚úÖ Set File Permissions (in cPanel File Manager):"
          echo "   - Navigate to: ~/public_html/myapp/backend/"
          echo "   - Right-click start.sh ‚Üí Change Permissions ‚Üí 755"
          echo ""
          echo "5. ‚úÖ Restart Node.js App:"
          echo "   - Go to: cPanel ‚Üí Node.js App ‚Üí Your App"
          echo "   - Click 'Restart'"
          echo ""
          echo "6. ‚úÖ Verify Deployment:"
          echo "   - Check logs: cPanel ‚Üí Node.js App ‚Üí Logs"
          echo "   - Look for: '‚úÖ Memory limit is correctly set: 2096.00MB'"
          echo "   - Look for: 'Server running on port...'"
          echo "   - Test API endpoints"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT:"
          echo "   ‚Ä¢ config.env was NOT deployed (use cPanel environment variables)"
          echo "   ‚Ä¢ node_modules must be installed on the server"
          echo "   ‚Ä¢ start.sh must be executable (755 permissions)"

      # ========================================
      # Step 11: Error Analysis
      # ========================================
      - name: üîç Error Analysis
        if: always()
        run: |
          echo ""
          echo "üîç ========================================"
          echo "üîç DEPLOYMENT STATUS ANALYSIS"
          echo "üîç ========================================"
          echo ""
          
          DISK_SPACE_OUTCOME="${{ steps.check-disk-space.outcome }}"
          VERIFY_DIRS_OUTCOME="${{ steps.verify-dirs.outcome }}"
          FTP_DEPLOY_OUTCOME="${{ steps.ftp-deploy.outcome }}"
          
          echo "üìä Step Status:"
          echo "  Step 6 (üíæ Check disk space): ${DISK_SPACE_OUTCOME:-unknown}"
          echo "  Step 7 (üß± Verify directories): ${VERIFY_DIRS_OUTCOME:-unknown}"
          echo "  Step 9 (üì§ Deploy via FTP): ${FTP_DEPLOY_OUTCOME:-unknown}"
          echo ""
          
          if [ "${{ job.status }}" != "success" ]; then
            echo "‚ùå DEPLOYMENT FAILED"
            echo ""
            
            if [ "$FTP_DEPLOY_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 9 (üì§ Deploy via FTP)"
              echo ""
              echo "üî¥ CHECK FOR DISK FULL ERROR (552) IN LOGS ABOVE"
              echo ""
              echo "If you see '552 Disk full' or 'No space':"
              echo ""
              echo "IMMEDIATE ACTIONS REQUIRED:"
              echo ""
              echo "1. Clean up server disk space:"
              echo "   ‚Ä¢ Log into cPanel ‚Üí File Manager"
              echo "   ‚Ä¢ Navigate to: ${{ env.FTP_DIR }}"
              echo "   ‚Ä¢ Delete:"
              echo "     - logs/ directory and all .log files"
              echo "     - tmp/ and .tmp/ directories"
              echo "     - node_modules/ (will be reinstalled with npm install)"
              echo "     - Old .zip and .tar.gz archives"
              echo "     - Any large backup files"
              echo ""
              echo "2. Check disk usage:"
              echo "   ‚Ä¢ Go to: cPanel ‚Üí Disk Usage"
              echo "   ‚Ä¢ Identify largest directories/files"
              echo "   ‚Ä¢ Delete unnecessary files"
              echo ""
              echo "3. After cleanup, retry deployment:"
              echo "   ‚Ä¢ Go to: GitHub Actions ‚Üí Re-run workflow"
              echo ""
              echo "Other common causes:"
              echo "  ‚Ä¢ FTP connection refused ‚Üí Check FTP_SERVER and FTP_PORT"
              echo "  ‚Ä¢ Authentication failed ‚Üí Check FTP_USERNAME and FTP_PASSWORD"
              echo "  ‚Ä¢ Directory not found ‚Üí Check FTP_DIR path"
              echo "  ‚Ä¢ Network timeout ‚Üí Check server connectivity"
              echo ""
              echo "üîç Action: Scroll up to Step 9 logs for detailed error"
            elif [ "$VERIFY_DIRS_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 7 (üß± Verify directories)"
              echo ""
              echo "This usually means:"
              echo "  ‚Ä¢ Cannot create directories on FTP server"
              echo "  ‚Ä¢ FTP user lacks write permissions"
              echo "  ‚Ä¢ Directory path is incorrect"
              echo ""
              echo "üîç Action: Scroll up to Step 7 logs for details"
            elif [ "$DISK_SPACE_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 6 (üíæ Check disk space)"
              echo ""
              echo "This usually means:"
              echo "  ‚Ä¢ Cannot connect to FTP server"
              echo "  ‚Ä¢ FTP credentials are incorrect"
              echo "  ‚Ä¢ Disk is full"
              echo ""
              echo "üîç Action: Scroll up to Step 6 logs for details"
            else
              echo "‚ùå FAILED: Earlier step (Steps 1-5)"
              echo ""
              echo "Check logs above to identify the failing step"
            fi
          else
            echo "‚úÖ All steps completed successfully!"
          fi
          
          echo ""
          echo "=========================================="

      # ========================================
      # Step 12: Final Error Handler
      # ========================================
      - name: üß† Final Error Handler
        if: failure()
        run: |
          echo ""
          echo "‚ùå ========================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "‚ùå ========================================"
          echo ""
          echo "üìã Quick Troubleshooting:"
          echo ""
          echo "1Ô∏è‚É£  Check GitHub Secrets:"
          echo "   Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "   Required: CPANEL_FTP_SERVER, CPANEL_FTP_USER, CPANEL_FTP_PASS"
          echo ""
          echo "2Ô∏è‚É£  Check Server Status:"
          echo "   ‚Ä¢ Log into cPanel ‚Üí File Manager"
          echo "   ‚Ä¢ Verify target directory exists: ${{ env.FTP_DIR }}"
          echo "   ‚Ä¢ Check disk space: cPanel ‚Üí Disk Usage"
          echo ""
          echo "3Ô∏è‚É£  Common Error Codes:"
          echo "   ‚Ä¢ 552 = Disk full"
          echo "   ‚Ä¢ 553 = Directory not found"
          echo "   ‚Ä¢ 530 = Authentication failed"
          echo "   ‚Ä¢ 421 = Connection timeout"
          echo "   ‚Ä¢ ECONNREFUSED = Cannot connect"
          echo ""
          echo "4Ô∏è‚É£  Scroll up to see detailed error analysis"
          echo ""
          echo "üí° Pro Tip: Check the 'üîç Error Analysis' step above for specific guidance"
          echo ""
