name: üöÄ Deploy Backend to cPanel

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FTP_DIR: "public_html/myapp"
  FTP_PORT: "21"

jobs:
  deploy:
    name: üåê Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benzflex.com

    steps:
      # ========================================
      # 1Ô∏è‚É£ Checkout Repository
      # ========================================
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      # ========================================
      # 2Ô∏è‚É£ Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ========================================
      # 3Ô∏è‚É£ Debug FTP Secrets (Show Real Values)
      # ========================================
      - name: üîç Debug FTP Secrets (Show Real Values)
        env:
          FTP_SERVER: ${{ Secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ Secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ Secrets.FTP_PASSWORD }}
        run: |
          echo "=========================================="
          echo "üîç FTP SECRETS - REAL VALUES (for debugging)"
          echo "=========================================="
          echo ""
          echo "üì° FTP_SERVER (real value):"
          echo "   $FTP_SERVER"
          echo ""
          echo "üë§ FTP_USERNAME (real value):"
          echo "   $FTP_USERNAME"
          echo ""
          echo "üîë FTP_PASSWORD (real value):"
          echo "   $FTP_PASSWORD"
          echo ""
          echo "üìÇ FTP_DIR (from env):"
          echo "   ${{ env.FTP_DIR }}"
          echo ""
          echo "üîå FTP_PORT (from env):"
          echo "   ${{ env.FTP_PORT }}"
          echo ""
          echo "=========================================="
          echo "‚úÖ These are the ACTUAL values that will be used for FTP deployment"
          echo "=========================================="

      # ========================================
      # 4Ô∏è‚É£ Verify FTP Secrets
      # ========================================
      - name: üîê Verify FTP Secrets
        run: |
          set -e
          echo "Verifying FTP secrets..."

          if [ -z "${{ secrets.FTP_SERVER }}" ]; then echo "::error::Missing FTP_SERVER"; exit 1; fi
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then echo "::error::Missing FTP_USERNAME"; exit 1; fi
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then echo "::error::Missing FTP_PASSWORD"; exit 1; fi

          echo "‚úÖ FTP secrets verified"
          echo "FTP_SERVER=${{ secrets.FTP_SERVER }}" >> $GITHUB_ENV
          echo "FTP_USERNAME=${{ secrets.FTP_USERNAME }}" >> $GITHUB_ENV
          echo "FTP_PASSWORD=${{ secrets.FTP_PASSWORD }}" >> $GITHUB_ENV
          echo "FTP_DIR=${{ env.FTP_DIR }}" >> $GITHUB_ENV
          echo "FTP_PORT=${{ env.FTP_PORT }}" >> $GITHUB_ENV

      # ========================================
      # 4Ô∏è‚É£ Install Dependencies (Optional)
      # ========================================
      - name: üì¶ Install dependencies
        working-directory: backend
        run: |
          echo "Installing production dependencies..."
          npm install --production --legacy-peer-deps

      # ========================================
      # 5Ô∏è‚É£ Prepare Deployment Package
      # ========================================
      - name: üßπ Prepare deployment package
        working-directory: backend
        run: |
          echo "Creating deployment package..."
          rm -rf deployment && mkdir deployment

          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.env' \
            --exclude='logs' \
            --exclude='tmp' \
            --exclude='tests' \
            --exclude='*.log' \
            --exclude='*.md' \
            ./ ./deployment/

          # Ensure start.sh is included
          if [ -f "start.sh" ]; then
            cp start.sh deployment/start.sh
            chmod +x deployment/start.sh
          fi

          echo "üì¶ Deployment package ready:"
          du -sh deployment | cut -f1

      # ========================================
      # 6Ô∏è‚É£ Deploy via FTP
      # ========================================
      - name: üì§ Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT }}
          local-dir: backend/deployment/
          server-dir: ${{ env.FTP_DIR }}
          log-level: verbose
          timeout: 120000
          dangerous-clean-slate: false
          exclude: |
            node_modules/**
            .git/**
            .github/**
            logs/**
            tmp/**
            tests/**
            *.env
            *.log
            *.md
            scripts/**
            .DS_Store

      # ========================================
      # 7Ô∏è‚É£ Deployment Summary
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo "üìÇ Uploaded to: ${{ env.FTP_DIR }}"
          echo "üåê Live URL: https://benzflex.com"
          echo ""
          echo "‚úÖ POST-DEPLOYMENT CHECKLIST:"
          echo "1. Log in to cPanel ‚Üí Node.js App ‚Üí Restart"
          echo "2. Set Application Root to: myapp"
          echo "3. Set Startup File to: start.sh"
          echo "4. Permissions: start.sh ‚Üí 755"
          echo "5. Environment Variables: Add STRIPE, CLOUDINARY, SENDGRID, etc."
          echo "6. Restart App and check logs"
          echo ""

      # ========================================
      # 8Ô∏è‚É£ Error Analysis
      # ========================================
      - name: ‚ùå Error Analysis
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå DEPLOYMENT FAILED"
          echo "=========================================="
          echo ""
          echo "üîç Possible Issues:"
          echo "‚Ä¢ Missing FTP secrets (check repo settings)"
          echo "‚Ä¢ Disk full (error 552)"
          echo "‚Ä¢ Wrong directory path (${{ env.FTP_DIR }})"
          echo "‚Ä¢ FTP timeout or invalid credentials"
          echo ""
          echo "üß∞ Fix Steps:"
          echo "1. Check GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
          echo "2. Clean up cPanel space (delete old logs/tmp/node_modules)"
          echo "3. Retry: GitHub Actions ‚Üí Re-run workflow"
          echo ""
