name: üöÄ Deploy Backend to cPanel

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FTP_DIR: "public_html/myapp"
  FTP_PORT: "21"

jobs:
  deploy:
    name: üåê Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: server
      url: https://benzflex.com

    steps:
      # ========================================
      # 1Ô∏è‚É£ Checkout Repository
      # ========================================
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ========================================
      # 2Ô∏è‚É£ Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ========================================
      # 3Ô∏è‚É£ Verify FTP Secrets
      # ========================================
      - name: üîê Verify FTP Secrets
        run: |
          set -e
          echo "=========================================="
          echo "üîê Verifying FTP Secrets"
          echo "=========================================="

          if [ -z "${{ secrets.FTP_SERVER }}" ]; then echo "::error::‚ùå Missing FTP_SERVER"; exit 1; fi
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then echo "::error::‚ùå Missing FTP_USERNAME"; exit 1; fi
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then echo "::error::‚ùå Missing FTP_PASSWORD"; exit 1; fi

          echo "‚úÖ All FTP secrets verified successfully"
          echo "FTP_SERVER=${{ secrets.FTP_SERVER }}" >> $GITHUB_ENV
          echo "FTP_USERNAME=${{ secrets.FTP_USERNAME }}" >> $GITHUB_ENV
          echo "FTP_PASSWORD=${{ secrets.FTP_PASSWORD }}" >> $GITHUB_ENV
          echo "FTP_DIR=${{ env.FTP_DIR }}" >> $GITHUB_ENV
          echo "FTP_PORT=${{ env.FTP_PORT }}" >> $GITHUB_ENV

      # ========================================
      # 4Ô∏è‚É£ Show Repository Structure
      # ========================================
      - name: üß≠ Show repository structure
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          ls -la
          echo ""
          echo "If you see a 'backend' folder, deployment will continue."

      # ========================================
      # 5Ô∏è‚É£ Prepare Deployment Package
      # ========================================
      - name: üßπ Prepare deployment package
        run: |
          echo "Creating deployment package..."
          cd backend
          rm -rf deployment && mkdir deployment

          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.env' \
            --exclude='logs' \
            --exclude='tmp' \
            --exclude='tests' \
            --exclude='*.log' \
            --exclude='*.md' \
            ./ ./deployment/

          # Include start.sh
          if [ -f "start.sh" ]; then
            cp start.sh deployment/start.sh
            chmod +x deployment/start.sh
          else
            echo "::warning::‚ö†Ô∏è start.sh not found in backend folder"
          fi

          echo "üì¶ Deployment package ready:"
          du -sh deployment | cut -f1

      # ========================================
      # 6Ô∏è‚É£ Deploy via FTP
      # ========================================
      - name: üì§ Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT }}
          local-dir: backend/deployment/
          server-dir: ${{ env.FTP_DIR }}
          log-level: verbose
          timeout: 120000
          dangerous-clean-slate: false
          exclude: |
            node_modules/**
            .git/**
            .github/**
            logs/**
            tmp/**
            tests/**
            *.env
            *.log
            *.md
            scripts/**
            .DS_Store

      # ========================================
      # 7Ô∏è‚É£ Deployment Summary
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo "üìÇ Uploaded to: ${{ env.FTP_DIR }}"
          echo "üåê Live URL: https://benzflex.com"
          echo ""
          echo "‚úÖ POST-DEPLOYMENT CHECKLIST:"
          echo "1. Log in to cPanel ‚Üí Node.js App ‚Üí Restart"
          echo "2. Set Application Root to: myapp"
          echo "3. Set Startup File to: start.sh"
          echo "4. Permissions: start.sh ‚Üí 755"
          echo "5. Add required Environment Variables"
          echo "6. Restart App and check logs"
          echo ""

      # ========================================
      # 8Ô∏è‚É£ Error Analysis
      # ========================================
      - name: ‚ùå Error Analysis
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå DEPLOYMENT FAILED"
          echo "=========================================="
          echo ""
          echo "üîç Possible Issues:"
          echo "‚Ä¢ Missing FTP secrets"
          echo "‚Ä¢ Disk full (error 552)"
          echo "‚Ä¢ Wrong FTP directory (${{ env.FTP_DIR }})"
          echo "‚Ä¢ FTP timeout or invalid credentials"
          echo ""
          echo "üß∞ Fix Steps:"
          echo "1. Go to GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
          echo "2. Ensure FTP_SERVER, FTP_USERNAME, FTP_PASSWORD are added"
          echo "3. Clean up cPanel space (logs/tmp/node_modules)"
          echo "4. Retry workflow from Actions tab"
