name: üöÄ FTP Deploy to cPanel

# Workflow triggers
on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering from GitHub Actions tab

jobs:
  deploy:
    name: üéâ Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: server
      url: https://benzflex.com

    steps:
      # ========================================
      # Step 1: Checkout Code
      # ========================================
      - name: üöö Checkout code
        uses: actions/checkout@v4

      # ========================================
      # Step 2: Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # ========================================
      # Step 3: Verify FTP Secrets
      # ========================================
      - name: üîç Verify FTP Secrets
        env:
          FTP_SERVER: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          FTP_PORT: ${{ secrets.CPANEL_FTP_PORT || '21' }}
        run: |
          echo "=== Verifying FTP Secrets ==="
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::One or more FTP secrets are missing!"
            echo "Required secrets:"
            echo "  - CPANEL_FTP_SERVER (or FTP_SERVER)"
            echo "  - CPANEL_FTP_USER (or FTP_USERNAME)"
            echo "  - CPANEL_FTP_PASS (or FTP_PASSWORD)"
            echo "Optional:"
            echo "  - CPANEL_FTP_DIR (default: public_html/myapp/)"
            echo "  - CPANEL_FTP_PORT (default: 21)"
            exit 1
          fi
          echo "‚úÖ FTP secrets verified"
          echo "FTP_SERVER: ${FTP_SERVER:0:10}... (length: ${#FTP_SERVER})"
          echo "FTP_USERNAME: ${FTP_USERNAME:0:5}... (length: ${#FTP_USERNAME})"
          echo "FTP_PASSWORD: *** (length: ${#FTP_PASSWORD})"
          echo "FTP_DIR: $FTP_DIR"
          echo "FTP_PORT: $FTP_PORT"

      # ========================================
      # Step 4: Install Dependencies
      # ========================================
      - name: üì¶ Install dependencies
        run: |
          echo "Installing production dependencies..."
          # Use npm install instead of npm ci to handle lock file sync issues
          npm install --omit=dev --legacy-peer-deps
          npm cache clean --force
          echo "‚úÖ Dependencies installed"

      # ========================================
      # Step 5: Clean Build Artifacts & Old Files
      # ========================================
      - name: üßπ Clean unnecessary files before deployment
        run: |
          echo "üßπ Cleaning build artifacts and old files..."
          
          # Remove large directories that shouldn't be deployed
          echo "Removing node_modules..."
          rm -rf node_modules
          
          # Remove version control
          echo "Removing .git and .github..."
          rm -rf .git .github
          
          # Remove logs and temp files
          echo "Removing logs and temp files..."
          rm -rf logs tmp .tmp
          find . -type f -name "*.log" -delete
          find . -type f -name "*.tmp" -delete
          
          # Remove test files
          echo "Removing test files..."
          find . -type f -name "test-*.js" -delete
          find . -type f -name "*.test.js" -delete
          find . -type f -name "*.spec.js" -delete
          
          # Remove monitoring/debug scripts
          echo "Removing debug scripts..."
          find . -type f -name "monitor-*.js" -delete
          find . -type f -name "quick-*.js" -delete
          find . -type f -name "run-*.js" -delete
          
          # Remove documentation
          echo "Removing documentation files..."
          find . -type f -name "*.md" -delete
          
          # Remove archives
          echo "Removing archive files..."
          find . -type f -name "*.zip" -delete
          find . -type f -name "*.tar.gz" -delete
          
          # Remove environment files (use cPanel env vars instead)
          echo "Removing environment files..."
          find . -type f -name "config.env" -delete
          find . -type f -name ".env*" -delete
          find . -type f -name "*.env" -delete
          
          # Remove scripts folder (not needed in production)
          echo "Removing scripts folder..."
          rm -rf scripts
          
          # Calculate size after cleaning
          CLEAN_SIZE=$(du -sh . | cut -f1)
          echo "üì¶ Size after cleaning: $CLEAN_SIZE"
          echo "‚úÖ Cleaning complete"

      # ========================================
      # Step 6: Prepare Deployment Package
      # ========================================
      - name: üßπ Prepare deployment package (minimal size)
        run: |
          echo "Preparing minimal deployment package..."
          rm -rf deployment
          mkdir -p deployment

          # Copy essential files only to minimize deployment size
          # This reduces deployment from ~100MB to ~5-10MB
          rsync -av \
                    --exclude='node_modules' \
                    --exclude='.git' \
                    --exclude='test' \
                    --exclude='.github/workflows' \
                    --exclude='deployment' \
                    --exclude='config.env' \
                    --exclude='*.env' \
                    --exclude='.env*' \
                    --exclude='*.log' \
                    --exclude='*.md' \
                    --exclude='**/*.md' \
                    --exclude='test-*.js' \
                    --exclude='quick-*.js' \
                    --exclude='monitor-*.js' \
                    --exclude='run-*.js' \
                    --exclude='*.sh' \
                    --exclude='Archive.zip' \
                    --exclude='production-run.log' \
                    --exclude='memory-monitor-report.json' \
                    --exclude='scripts' \
                    --exclude='.gitignore' \
                    --exclude='README.md' \
                    --exclude='tmp' \
                    --exclude='logs' \
                    ./ ./deployment/

          # CRITICAL: Copy start.sh separately (was excluded by *.sh pattern)
          cp start.sh deployment/start.sh
          chmod +x deployment/start.sh
          
          # CRITICAL: Ensure .github/scripts directory exists for verification script
          # (Note: The script runs BEFORE deployment, so it needs to be available in the runner)
          # We don't deploy .github/scripts, but we need it during the workflow
          
          # Calculate deployment size
          DEPLOY_SIZE=$(du -sh deployment | cut -f1)
          echo "üì¶ Deployment package size: $DEPLOY_SIZE"
          echo ""
          echo "üì¶ Essential files included:"
          ls -la deployment/ | grep -E "(start.sh|server.js|app.js|package.json)" || echo "  Checking..."
          echo ""
          echo "‚úÖ Verifying critical files:"
          [ -f "deployment/start.sh" ] && echo "  ‚úÖ start.sh" || echo "  ‚ùå start.sh MISSING!"
          [ -f "deployment/server.js" ] && echo "  ‚úÖ server.js" || echo "  ‚ùå server.js MISSING!"
          [ -f "deployment/package.json" ] && echo "  ‚úÖ package.json" || echo "  ‚ùå package.json MISSING!"
          [ ! -f "deployment/config.env" ] && echo "  ‚úÖ config.env excluded (good)" || echo "  ‚ö†Ô∏è  config.env included (should be excluded!)"

      # ========================================
      # Step 7: Check Remote Disk Space
      # ========================================
      # This step prevents "FTPError: 552 Disk full" by checking available disk space
      # on the remote server before attempting deployment. It can also attempt
      # automatic cleanup of temporary files if disk space is low.
      - name: üíæ Check remote disk space
        id: check-disk-space
        run: |
          echo "Installing basic-ftp for disk space check..."
          npm install basic-ftp --no-save
          echo "‚úÖ basic-ftp installed"
          echo ""
          echo "Running disk space check script..."
          node .github/scripts/checkDiskSpace.js
        env:
          FTP_SERVER: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          FTP_PORT: ${{ secrets.CPANEL_FTP_PORT || '21' }}
 

      # ========================================
      # Step 8: Verify Remote FTP Directories
      # ========================================
      # This step prevents "FTPError: 553 Can't open that file" by ensuring
      # all required directories exist on the remote server before deployment.
      # The script checks and creates missing folders like /controllers, /models, etc.
      - name: üß± Verify remote directories exist
        id: verify-dirs
        run: |
          echo "Installing basic-ftp for directory verification..."
          npm install basic-ftp --no-save
          echo "‚úÖ basic-ftp installed"
          echo ""
          echo "Running FTP directory verification script..."
          node .github/scripts/checkFtpDirs.js
        env:
          FTP_SERVER: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          FTP_PORT: ${{ secrets.CPANEL_FTP_PORT || '21' }}
          

      # ========================================
      # Step 9: Deploy via FTP (with retry)
      # ========================================
      - name: üì§ Deploy to cPanel via FTP
        id: ftp-deploy
        continue-on-error: false
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          port: ${{ secrets.CPANEL_FTP_PORT || 21 }}
          local-dir: ./deployment/
          server-dir: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          exclude: |
            node_modules/**
            test/**
            .git*
            .github/**
            deployment/**
            config.env
            *.env
            .env*
            *.log
            *.md
            **/*.md
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            *.sh
            !start.sh
            Archive.zip
            production-run.log
            memory-monitor-report.json
            scripts/**
            .gitignore
            README.md
            tmp/**
            logs/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 60000
          dry-run: false

      # ========================================
      # Step 10: Retry on Failure (552 Disk Full)
      # ========================================
      - name: üîÑ Retry deployment on failure
        if: failure() && steps.ftp-deploy.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          port: ${{ secrets.CPANEL_FTP_PORT || 21 }}
          local-dir: ./deployment/
          server-dir: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          exclude: |
            node_modules/**
            test/**
            .git*
            .github/**
            deployment/**
            config.env
            *.env
            .env*
            *.log
            *.md
            **/*.md
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            *.sh
            !start.sh
            Archive.zip
            production-run.log
            memory-monitor-report.json
            scripts/**
            .gitignore
            README.md
            tmp/**
            logs/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 60000

      # ========================================
      # Step 11: Post-Deployment Instructions
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo ""
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "======================================"
          echo "üåê Application deployed to: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}"
          echo "üîó Live URL: https://benzflex.com"
          echo ""
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo "  1. ‚úÖ Set start.sh permissions to 755 in cPanel File Manager"
          echo "  2. ‚úÖ Verify cPanel Node.js App 'Startup File' = start.sh"
          echo "  3. ‚úÖ Verify NODE_OPTIONS env var = --max-old-space-size=2048 --expose-gc"
          echo "  4. ‚úÖ Verify all environment variables are set in cPanel"
          echo "  5. ‚úÖ Install dependencies: npm install --production (on server)"
          echo "  6. ‚úÖ Restart Node.js app in cPanel"
          echo "  7. ‚úÖ Check logs for 'Server running' message"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: config.env was NOT deployed (use cPanel environment variables)"

      # ========================================
      # Step 11.5: Capture Error Details
      # ========================================
      - name: üîç Capture error details
        if: failure()
        run: |
          echo ""
          echo "üîç ========================================"
          echo "üîç ERROR ANALYSIS"
          echo "üîç ========================================"
          echo ""
          echo "Checking which step failed..."
          echo ""
          if [ "${{ steps.ftp-deploy.outcome }}" == "failure" ]; then
            echo "‚ùå Step 9 (üì§ Deploy via FTP) FAILED"
            echo ""
            echo "Common causes:"
            echo "  ‚Ä¢ FTP connection refused (check FTP_SERVER and FTP_PORT)"
            echo "  ‚Ä¢ Authentication failed (check FTP_USERNAME and FTP_PASSWORD)"
            echo "  ‚Ä¢ Directory not found (check FTP_DIR path)"
            echo "  ‚Ä¢ Disk full (should have been caught in Step 7)"
            echo "  ‚Ä¢ Network timeout"
            echo ""
            echo "Check the Step 9 logs above for the specific error code."
          elif [ "${{ steps.check-disk-space.outcome }}" == "failure" ]; then
            echo "‚ùå Step 7 (üíæ Check remote disk space) FAILED"
            echo ""
            echo "This usually means:"
            echo "  ‚Ä¢ Cannot connect to FTP server"
            echo "  ‚Ä¢ FTP credentials are incorrect"
            echo "  ‚Ä¢ Disk is full and cleanup failed"
            echo ""
            echo "Check the Step 7 logs above for connection/disk errors."
          elif [ "${{ steps.verify-dirs.outcome }}" == "failure" ]; then
            echo "‚ùå Step 8 (üß± Verify remote directories) FAILED"
            echo ""
            echo "This usually means:"
            echo "  ‚Ä¢ Cannot create directories on FTP server"
            echo "  ‚Ä¢ FTP user lacks write permissions"
            echo "  ‚Ä¢ Directory path is incorrect"
            echo ""
            echo "Check the Step 8 logs above for permission/path errors."
          else
            echo "‚ùå An earlier step failed (Steps 1-6)"
            echo ""
            echo "Check the logs above to see which step failed."
          fi
          echo ""
          echo "=========================================="
          echo ""
      
      # ========================================
      # Step 12: Handle Upload Errors
      # ========================================
      - name: üß† Handle upload errors
        if: failure()
        run: |
          echo ""
          echo "‚ùå ========================================"
          echo "‚ùå FTP DEPLOYMENT FAILED"
          echo "‚ùå ========================================"
          echo ""
          echo "üîç IMPORTANT: Scroll up to see the ACTUAL error message!"
          echo "   The error details are in the steps above this message."
          echo "   Look for the 'üîç ERROR ANALYSIS' section above."
          echo ""
          echo "üìã Troubleshooting Steps:"
          echo ""
          echo "1Ô∏è‚É£  Find the Actual Error:"
          echo "   - Scroll up in the logs to find the failing step"
          echo "   - Look for error messages with codes like:"
          echo "     ‚Ä¢ 552 = Disk full"
          echo "     ‚Ä¢ 553 = Directory not found"
          echo "     ‚Ä¢ 530 = Authentication failed"
          echo "     ‚Ä¢ 421 = Connection timeout"
          echo "     ‚Ä¢ ECONNREFUSED = Cannot connect to server"
          echo ""
          echo "2Ô∏è‚É£  Check Which Step Failed:"
          echo "   - Step 7 (üíæ Check remote disk space) = Disk space issue"
          echo "   - Step 8 (üß± Verify directories) = Directory creation issue"
          echo "   - Step 9 (üì§ Deploy via FTP) = Upload/connection issue"
          echo ""
          echo "3Ô∏è‚É£  Verify GitHub Secrets:"
          echo "   - Go to: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "   - Required secrets (use CPANEL_* or FTP_* versions):"
          echo "     ‚Ä¢ CPANEL_FTP_SERVER (or FTP_SERVER)"
          echo "     ‚Ä¢ CPANEL_FTP_USER (or FTP_USERNAME)"
          echo "     ‚Ä¢ CPANEL_FTP_PASS (or FTP_PASSWORD)"
          echo "   - Optional secrets:"
          echo "     ‚Ä¢ CPANEL_FTP_DIR (default: public_html/myapp/)"
          echo "     ‚Ä¢ CPANEL_FTP_PORT (default: 21)"
          echo ""
          echo "4Ô∏è‚É£  Check Server Status in cPanel:"
          echo "   - Log into cPanel ‚Üí File Manager"
          echo "   - Verify target directory exists (check path in Step 3 logs)"
          echo "   - Check disk space: cPanel ‚Üí Disk Usage"
          echo "   - Verify FTP account is active: cPanel ‚Üí FTP Accounts"
          echo "   - Test FTP connection manually if possible"
          echo ""
          echo "5Ô∏è‚É£  Common Error Solutions:"
          echo ""
          echo "   Error 552 (Disk full):"
          echo "   ‚Üí Go to cPanel ‚Üí File Manager"
          echo "   ‚Üí Delete old logs, temp files, backups"
          echo "   ‚Üí Check Disk Usage in cPanel"
          echo "   ‚Üí The disk space check step should have attempted cleanup"
          echo ""
          echo "   Error 553 (Directory not found):"
          echo "   ‚Üí Create the directory in cPanel File Manager"
          echo "   ‚Üí Ensure path matches CPANEL_FTP_DIR secret"
          echo "   ‚Üí Check Step 8 logs for which directories failed"
          echo ""
          echo "   Error 530 (Authentication failed):"
          echo "   ‚Üí Verify FTP username and password in GitHub Secrets"
          echo "   ‚Üí Check cPanel ‚Üí FTP Accounts to confirm credentials"
          echo "   ‚Üí Ensure FTP account has access to target directory"
          echo ""
          echo "   Connection timeout/refused:"
          echo "   ‚Üí Verify FTP_SERVER hostname is correct"
          echo "   ‚Üí Check FTP_PORT (usually 21)"
          echo "   ‚Üí Ensure firewall allows FTP connections"
          echo ""
          echo "6Ô∏è‚É£  Quick Fixes to Try:"
          echo "   a) Wait 2-3 minutes and retry the workflow"
          echo "   b) Verify all GitHub Secrets are set correctly"
          echo "   c) Check cPanel ‚Üí Disk Usage for available space"
          echo "   d) Manually create target directory if missing"
          echo "   e) Test FTP connection with FileZilla or similar tool"
          echo ""
          echo "üí° Pro Tip:"
          echo "   Check the 'üíæ Check remote disk space' step logs first"
          echo "   It will show detailed connection and disk space information"
          echo ""
          exit 1
