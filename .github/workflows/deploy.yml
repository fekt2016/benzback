name: üöÄ Deploy Backend to cPanel

# Workflow triggers
on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Manual trigger

# Environment variables (reusable across steps)
env:
  NODE_VERSION: "20"
  FTP_DIR_DEFAULT: "public_html/myapp/backend"
  FTP_PORT_DEFAULT: "21"

jobs:
  deploy:
    name: üéâ Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benzflex.com

    # Reusable environment variables for FTP operations
    defaults:
      run:
        working-directory: backend

    steps:
      # ========================================
      # Step 1: Checkout Code
      # ========================================
      - name: üöö Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ========================================
      # Step 2: Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ========================================
      # Step 3: Verify and Set FTP Secrets
      # ========================================
      - name: üîç Verify FTP Secrets
        id: verify-secrets
        run: |
          echo "=== Verifying FTP Secrets ==="
          
          FTP_SERVER="${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}"
          FTP_USERNAME="${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}"
          FTP_PASSWORD="${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}"
          FTP_DIR="${{ secrets.CPANEL_FTP_DIR || env.FTP_DIR_DEFAULT }}"
          FTP_PORT="${{ secrets.CPANEL_FTP_PORT || env.FTP_PORT_DEFAULT }}"
          
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::Missing required FTP secrets!"
            echo ""
            echo "Required GitHub Secrets:"
            echo "  - CPANEL_FTP_SERVER (or FTP_SERVER)"
            echo "  - CPANEL_FTP_USER (or FTP_USERNAME)"
            echo "  - CPANEL_FTP_PASS (or FTP_PASSWORD)"
            echo ""
            echo "Optional Secrets:"
            echo "  - CPANEL_FTP_DIR (default: ${{ env.FTP_DIR_DEFAULT }})"
            echo "  - CPANEL_FTP_PORT (default: ${{ env.FTP_PORT_DEFAULT }})"
            exit 1
          fi
          
          echo "‚úÖ FTP secrets verified"
          echo "FTP_SERVER: ${FTP_SERVER:0:15}..."
          echo "FTP_USERNAME: ${FTP_USERNAME:0:10}..."
          echo "FTP_DIR: $FTP_DIR"
          echo "FTP_PORT: $FTP_PORT"
          
          # Export for later steps
          echo "FTP_SERVER=$FTP_SERVER" >> $GITHUB_ENV
          echo "FTP_USERNAME=$FTP_USERNAME" >> $GITHUB_ENV
          echo "FTP_PASSWORD=$FTP_PASSWORD" >> $GITHUB_ENV
          echo "FTP_DIR=$FTP_DIR" >> $GITHUB_ENV
          echo "FTP_PORT=$FTP_PORT" >> $GITHUB_ENV

      # ========================================
      # Step 4: Install Script Dependencies
      # ========================================
      - name: üì¶ Install script dependencies
        run: |
          echo "Installing basic-ftp for pre-deployment checks..."
          npm install basic-ftp --no-save --legacy-peer-deps
          echo "‚úÖ Dependencies installed"

      # ========================================
      # Step 5: Pre-Deployment Checks
      # ========================================
      - name: üíæ Check remote disk space
        id: check-disk-space
        run: node .github/scripts/checkDiskSpace.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}

      - name: üß± Verify remote directories
        id: verify-dirs
        run: node .github/scripts/checkFtpDirs.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}

      - name: üßΩ Clean old files on FTP
        id: cleanup-old-files
        continue-on-error: true
        run: node .github/scripts/cleanupOldFiles.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}

      # ========================================
      # Step 6: Prepare Deployment Package
      # ========================================
      - name: üßπ Prepare deployment package
        id: prepare-package
        run: |
          set -e
          
          echo "Preparing minimal deployment package..."
          echo ""
          
          # Clean and create deployment directory
          rm -rf deployment
          mkdir -p deployment
          
          # Define exclusion patterns (reusable)
          EXCLUDE_PATTERNS=(
            '--exclude=node_modules'
            '--exclude=.git'
            '--exclude=.github'
            '--exclude=test'
            '--exclude=tests'
            '--exclude=*.test.js'
            '--exclude=*.spec.js'
            '--exclude=logs'
            '--exclude=*.log'
            '--exclude=*.md'
            '--exclude=**/*.md'
            '--exclude=config.env'
            '--exclude=*.env'
            '--exclude=.env*'
            '--exclude=tmp'
            '--exclude=temp'
            '--exclude=deployment'
            '--exclude=production-archive'
            '--exclude=production-package'
            '--exclude=test-*.js'
            '--exclude=monitor-*.js'
            '--exclude=run-*.js'
            '--exclude=check-*.js'
            '--exclude=analyze-*.js'
            '--exclude=*.zip'
            '--exclude=*.tar.gz'
            '--exclude=.gitignore'
            '--exclude=.DS_Store'
            '--exclude=*.swp'
            '--exclude=*.swo'
            '--exclude=.vscode'
            '--exclude=.idea'
            '--exclude=coverage'
            '--exclude=.nyc_output'
            '--exclude=scripts'
          )
          
          # Copy files with exclusions
          rsync -av "${EXCLUDE_PATTERNS[@]}" ./ ./deployment/
          
          # Ensure start.sh is included and executable
          if [ ! -f "start.sh" ]; then
            echo "::error::start.sh not found!"
            exit 1
          fi
          cp start.sh deployment/start.sh
          chmod +x deployment/start.sh
          echo "‚úÖ start.sh included and made executable"
          
          # Calculate and display package size
          DEPLOY_SIZE_BYTES=$(du -sb deployment | cut -f1)
          DEPLOY_SIZE_MB=$(echo "scale=2; $DEPLOY_SIZE_BYTES / 1024 / 1024" | bc)
          echo ""
          echo "üì¶ Deployment package size: ~${DEPLOY_SIZE_MB}MB"
          
          if (( $(echo "$DEPLOY_SIZE_MB > 50" | bc -l) )); then
            echo "::warning::Package size is large (${DEPLOY_SIZE_MB}MB) - may cause disk space issues"
          fi
          
          # Verify critical files
          echo ""
          echo "‚úÖ Verifying critical files..."
          CRITICAL_FILES=(
            "server.js"
            "app.js"
            "package.json"
            "start.sh"
            "services/stripeClient.js"
            "services/cloudinaryClient.js"
            "services/sendGridClient.js"
            "middleware/bookingUpload.js"
          )
          
          MISSING_FILES=()
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "deployment/$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "::error::Critical files missing: ${MISSING_FILES[*]}"
            exit 1
          fi
          
          # Verify directories
          echo "‚úÖ Verifying directories..."
          REQUIRED_DIRS=("controllers" "routes" "models" "services" "utils" "middleware" "socket")
          MISSING_DIRS=()
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "deployment/$dir" ]; then
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo "::error::Required directories missing: ${MISSING_DIRS[*]}"
            exit 1
          fi
          
          echo "‚úÖ Deployment package ready!"

      # ========================================
      # Step 7: Deploy via FTP
      # ========================================
      - name: üì§ Deploy to cPanel via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT }}
          local-dir: backend/deployment/
          server-dir: ${{ env.FTP_DIR }}
          exclude: |
            node_modules/**
            .git/**
            .github/**
            test/**
            tests/**
            *.test.js
            *.spec.js
            logs/**
            *.log
            *.md
            **/*.md
            config.env
            *.env
            .env*
            tmp/**
            temp/**
            deployment/**
            production-archive/**
            production-package/**
            test-*.js
            monitor-*.js
            run-*.js
            check-*.js
            analyze-*.js
            *.zip
            *.tar.gz
            .gitignore
            .DS_Store
            scripts/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 120000

      # ========================================
      # Step 8: Post-Deployment Summary
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo ""
          echo "üéâ ========================================"
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "üéâ ========================================"
          echo ""
          echo "üåê Application deployed to: ${{ env.FTP_DIR }}"
          echo "üîó Live URL: https://benzflex.com"
          echo ""
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo ""
          echo "1. Install Dependencies:"
          echo "   cd ~/public_html/myapp/backend"
          echo "   npm install --production --legacy-peer-deps"
          echo ""
          echo "2. Set Environment Variables (cPanel ‚Üí Node.js App):"
          echo "   ‚Ä¢ STRIPE_SECRET_KEY"
          echo "   ‚Ä¢ CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET"
          echo "   ‚Ä¢ SENDGRID_API_KEY"
          echo "   ‚Ä¢ NODE_OPTIONS=--max-old-space-size=2048 --expose-gc"
          echo "   ‚Ä¢ DEBUG_KEY"
          echo ""
          echo "3. Set Startup File: start.sh"
          echo "4. Set File Permissions: chmod 755 start.sh"
          echo "5. Restart Node.js App"
          echo "6. Verify: Check logs for 'Server running' message"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT:"
          echo "   ‚Ä¢ config.env was NOT deployed (use cPanel env vars)"
          echo "   ‚Ä¢ node_modules must be installed on server"
          echo "   ‚Ä¢ start.sh must be executable (755)"

      # ========================================
      # Step 9: Error Analysis
      # ========================================
      - name: üîç Error Analysis
        if: always()
        run: |
          echo ""
          echo "üîç ========================================"
          echo "üîç DEPLOYMENT STATUS ANALYSIS"
          echo "üîç ========================================"
          echo ""
          
          DISK_SPACE_OUTCOME="${{ steps.check-disk-space.outcome }}"
          VERIFY_DIRS_OUTCOME="${{ steps.verify-dirs.outcome }}"
          CLEANUP_OUTCOME="${{ steps.cleanup-old-files.outcome }}"
          PREPARE_OUTCOME="${{ steps.prepare-package.outcome }}"
          FTP_DEPLOY_OUTCOME="${{ steps.ftp-deploy.outcome }}"
          
          echo "üìä Step Status:"
          echo "  Step 5.1 (üíæ Check disk space): ${DISK_SPACE_OUTCOME:-unknown}"
          echo "  Step 5.2 (üß± Verify directories): ${VERIFY_DIRS_OUTCOME:-unknown}"
          echo "  Step 5.3 (üßΩ Clean old files): ${CLEANUP_OUTCOME:-unknown}"
          echo "  Step 6 (üßπ Prepare package): ${PREPARE_OUTCOME:-unknown}"
          echo "  Step 7 (üì§ Deploy via FTP): ${FTP_DEPLOY_OUTCOME:-unknown}"
          echo ""
          
          if [ "${{ job.status }}" != "success" ]; then
            echo "‚ùå DEPLOYMENT FAILED"
            echo ""
            
            if [ "$FTP_DEPLOY_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 7 (üì§ Deploy via FTP)"
              echo ""
              echo "üî¥ Check for disk full error (552) in logs above"
              echo ""
              echo "If you see '552 Disk full' or 'No space':"
              echo "  1. Clean up server disk space (logs, tmp, node_modules)"
              echo "  2. Check cPanel ‚Üí Disk Usage"
              echo "  3. Retry deployment"
              echo ""
              echo "Other common causes:"
              echo "  ‚Ä¢ FTP connection refused ‚Üí Check FTP_SERVER and FTP_PORT"
              echo "  ‚Ä¢ Authentication failed ‚Üí Check FTP_USERNAME and FTP_PASSWORD"
              echo "  ‚Ä¢ Directory not found ‚Üí Check FTP_DIR path"
              echo "  ‚Ä¢ Network timeout ‚Üí Check server connectivity"
            elif [ "$PREPARE_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 6 (üßπ Prepare package)"
              echo "  Check logs above for missing files or directories"
            elif [ "$VERIFY_DIRS_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 5.2 (üß± Verify directories)"
              echo "  Cannot create directories on FTP server"
            elif [ "$DISK_SPACE_OUTCOME" == "failure" ]; then
              echo "‚ùå FAILED: Step 5.1 (üíæ Check disk space)"
              echo "  Cannot connect to FTP or disk is full"
            else
              echo "‚ùå FAILED: Earlier step"
              echo "  Check logs above to identify the failing step"
            fi
          else
            echo "‚úÖ All steps completed successfully!"
          fi
          
          echo ""
          echo "=========================================="

      # ========================================
      # Step 10: Final Error Handler
      # ========================================
      - name: üß† Final Error Handler
        if: failure()
        run: |
          echo ""
          echo "‚ùå ========================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "‚ùå ========================================"
          echo ""
          echo "üìã Quick Troubleshooting:"
          echo ""
          echo "1Ô∏è‚É£  Check GitHub Secrets:"
          echo "   Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "   Required: CPANEL_FTP_SERVER, CPANEL_FTP_USER, CPANEL_FTP_PASS"
          echo ""
          echo "2Ô∏è‚É£  Check Server Status:"
          echo "   ‚Ä¢ Verify target directory: ${{ env.FTP_DIR }}"
          echo "   ‚Ä¢ Check disk space: cPanel ‚Üí Disk Usage"
          echo ""
          echo "3Ô∏è‚É£  Common Error Codes:"
          echo "   ‚Ä¢ 552 = Disk full"
          echo "   ‚Ä¢ 553 = Directory not found"
          echo "   ‚Ä¢ 530 = Authentication failed"
          echo "   ‚Ä¢ 421 = Connection timeout"
          echo ""
          echo "4Ô∏è‚É£  See 'üîç Error Analysis' step above for details"
          echo ""
