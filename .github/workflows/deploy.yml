name: üöÄ Deploy Backend to cPanel

on:
  push:
    branches: [main]
    paths:
      - "**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FTP_DIR: "public_html/myapp/"
  FTP_PORT: "21"

jobs:
  deploy:
    name: üåê Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: server
      url: https://benzflex.com

    steps:
      # ========================================
      # 1Ô∏è‚É£ Checkout Repository
      # ========================================
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ========================================
      # 2Ô∏è‚É£ Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ========================================
      # 3Ô∏è‚É£ Verify FTP Secrets
      # ========================================
      - name: üîê Verify FTP Secrets
        run: |
          set -e
          echo "=========================================="
          echo "üîê Verifying FTP Secrets"
          echo "=========================================="

          if [ -z "${{ secrets.FTP_SERVER }}" ]; then echo "::error::‚ùå Missing FTP_SERVER"; exit 1; fi
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then echo "::error::‚ùå Missing FTP_USERNAME"; exit 1; fi
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then echo "::error::‚ùå Missing FTP_PASSWORD"; exit 1; fi

          echo "‚úÖ All FTP secrets verified successfully"
          echo "FTP_SERVER=${{ secrets.FTP_SERVER }}" >> $GITHUB_ENV
          echo "FTP_USERNAME=${{ secrets.FTP_USERNAME }}" >> $GITHUB_ENV
          echo "FTP_PASSWORD=${{ secrets.FTP_PASSWORD }}" >> $GITHUB_ENV
          echo "FTP_DIR=${{ env.FTP_DIR }}" >> $GITHUB_ENV
          echo "FTP_PORT=${{ env.FTP_PORT }}" >> $GITHUB_ENV

      # ========================================
      # 4Ô∏è‚É£ Show Repository Structure
      # ========================================
      - name: üß≠ Show repository structure
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          ls -la
          echo ""
          echo "‚úÖ Confirm your server.js, app.js, and package.json appear above."

      # ========================================
      # 5Ô∏è‚É£ Clean Up Old Files on Server (Before Deploy)
      # ========================================
      - name: üßπ Clean up old files on FTP server
        continue-on-error: true
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ env.FTP_DIR }}
          FTP_PORT: ${{ env.FTP_PORT }}
        run: |
          echo "=========================================="
          echo "üßπ Cleaning up old files on FTP server"
          echo "=========================================="
          echo ""
          echo "Installing basic-ftp for cleanup..."
          npm install -g basic-ftp
          
          node << 'EOF'
          const { Client } = require('basic-ftp');
          const client = new Client();
          
          async function cleanup() {
            try {
              await client.access({
                host: process.env.FTP_SERVER,
                user: process.env.FTP_USERNAME,
                password: process.env.FTP_PASSWORD,
                port: parseInt(process.env.FTP_PORT || '21'),
              });
              
              const targetDir = process.env.FTP_DIR.replace(/\/$/, '');
              console.log(`üìÇ Connected to FTP server`);
              console.log(`üìÇ Target directory: ${targetDir}`);
              
              // List of files/folders to delete
              const itemsToDelete = [
                'node_modules',
                'logs',
                'tmp',
                'temp',
                '*.log',
                '*.zip',
                '*.tar.gz',
                '*.bak',
                'deployment',
                'production-archive',
                'production-package',
              ];
              
              let deletedCount = 0;
              
              try {
                await client.cd(targetDir);
                const list = await client.list();
                
                for (const item of list) {
                  const name = item.name;
                  const isDir = item.isDirectory;
                  
                  // Check if item should be deleted
                  const shouldDelete = itemsToDelete.some(pattern => {
                    if (pattern.includes('*')) {
                      const regex = new RegExp(pattern.replace('*', '.*'));
                      return regex.test(name);
                    }
                    return name === pattern;
                  });
                  
                  if (shouldDelete) {
                    try {
                      if (isDir) {
                        await client.removeDir(name);
                        console.log(`‚úÖ Deleted directory: ${name}`);
                      } else {
                        await client.remove(name);
                        console.log(`‚úÖ Deleted file: ${name}`);
                      }
                      deletedCount++;
                    } catch (err) {
                      console.log(`‚ö†Ô∏è  Could not delete ${name}: ${err.message}`);
                    }
                  }
                }
              } catch (err) {
                console.log(`‚ö†Ô∏è  Could not list directory: ${err.message}`);
              }
              
              console.log(`\n‚úÖ Cleanup complete. Deleted ${deletedCount} items.`);
              await client.close();
            } catch (error) {
              console.log(`‚ö†Ô∏è  Cleanup failed (non-critical): ${error.message}`);
              console.log(`‚ö†Ô∏è  Continuing with deployment...`);
            }
          }
          
          cleanup();
          EOF
          
          echo ""
          echo "=========================================="

      # ========================================
      # 6Ô∏è‚É£ Prepare Deployment Package (Minimal)
      # ========================================
      - name: üßπ Prepare minimal deployment package
        run: |
          echo "=========================================="
          echo "üì¶ Creating minimal deployment package"
          echo "=========================================="
          echo ""
          rm -rf deployment && mkdir deployment

          # Only include essential files
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.env' \
            --exclude='.env*' \
            --exclude='config.env' \
            --exclude='logs' \
            --exclude='tmp' \
            --exclude='temp' \
            --exclude='tests' \
            --exclude='test' \
            --exclude='*.test.js' \
            --exclude='*.spec.js' \
            --exclude='*.log' \
            --exclude='*.md' \
            --exclude='**/*.md' \
            --exclude='scripts' \
            --exclude='coverage' \
            --exclude='.nyc_output' \
            --exclude='.DS_Store' \
            --exclude='*.swp' \
            --exclude='*.swo' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='*.zip' \
            --exclude='*.tar.gz' \
            --exclude='deployment' \
            --exclude='production-archive' \
            --exclude='production-package' \
            ./ ./deployment/

          # Include start.sh
          if [ -f "start.sh" ]; then
            cp start.sh deployment/start.sh
            chmod +x deployment/start.sh
            echo "‚úÖ start.sh included"
          else
            echo "::warning::‚ö†Ô∏è start.sh not found in root folder"
          fi

          echo ""
          echo "üì¶ Deployment package size:"
          du -sh deployment | cut -f1
          echo ""
          echo "üìä Package contents:"
          find deployment -type f | wc -l | xargs echo "   Files:"
          find deployment -type d | wc -l | xargs echo "   Directories:"
          echo ""
          echo "=========================================="

      # ========================================
      # 7Ô∏è‚É£ Deploy via FTP
      # ========================================
      - name: üì§ Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT }}
          local-dir: deployment/
          server-dir: ${{ env.FTP_DIR }}
          log-level: verbose
          timeout: 120000
          dangerous-clean-slate: false
          exclude: |
            node_modules/**
            .git/**
            .github/**
            logs/**
            tmp/**
            tests/**
            *.env
            *.log
            *.md
            scripts/**
            .DS_Store

      # ========================================
      # 8Ô∏è‚É£ Deployment Summary
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo "üìÇ Uploaded to: ${{ env.FTP_DIR }}"
          echo "üåê Live URL: https://benzflex.com"
          echo ""
          echo "‚úÖ POST-DEPLOYMENT CHECKLIST:"
          echo "1. Log in to cPanel ‚Üí Node.js App ‚Üí Restart"
          echo "2. Set Application Root to: myapp"
          echo "3. Set Startup File to: start.sh"
          echo "4. Permissions: start.sh ‚Üí 755"
          echo "5. Environment Variables: Add STRIPE, CLOUDINARY, SENDGRID, etc."
          echo "6. Restart App and check log"
          echo ""

      # ========================================
      # 9Ô∏è‚É£ Error Analysis (552 Disk Full)
      # ========================================
      - name: ‚ùå Error Analysis
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå DEPLOYMENT FAILED - ERROR 552 (Disk Full)"
          echo "=========================================="
          echo ""
          echo "üî¥ CRITICAL: Server disk is full!"
          echo ""
          echo "üîç Immediate Actions Required:"
          echo ""
          echo "1Ô∏è‚É£  MANUAL CLEANUP (via cPanel File Manager):"
          echo "   ‚Ä¢ Go to: cPanel ‚Üí File Manager ‚Üí ${{ env.FTP_DIR }}"
          echo "   ‚Ä¢ Delete these folders/files:"
          echo "     - node_modules/ (if exists)"
          echo "     - logs/ (if exists)"
          echo "     - tmp/ or temp/ (if exists)"
          echo "     - *.log files"
          echo "     - *.zip, *.tar.gz files"
          echo "     - deployment/ folder (old deployments)"
          echo ""
          echo "2Ô∏è‚É£  CHECK DISK USAGE:"
          echo "   ‚Ä¢ Go to: cPanel ‚Üí Disk Usage"
          echo "   ‚Ä¢ Identify large files/folders"
          echo "   ‚Ä¢ Delete unnecessary files"
          echo ""
          echo "3Ô∏è‚É£  RETRY DEPLOYMENT:"
          echo "   ‚Ä¢ After cleanup, go to: GitHub ‚Üí Actions"
          echo "   ‚Ä¢ Click 'Re-run all jobs' on the failed workflow"
          echo ""
          echo "4Ô∏è‚É£  PREVENT FUTURE ISSUES:"
          echo "   ‚Ä¢ The workflow now auto-cleans old files before deploy"
          echo "   ‚Ä¢ Consider upgrading hosting plan if disk is consistently full"
          echo ""
          echo "=========================================="
