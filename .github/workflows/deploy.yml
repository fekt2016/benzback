name: üöÄ FTP Deploy to cPanel

# Workflow triggers
on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering from GitHub Actions tab

jobs:
  deploy:
    name: üéâ Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: server
      url: https://benzflex.com

    steps:
      # ========================================
      # Step 1: Checkout Code
      # ========================================
      - name: üöö Checkout code
        uses: actions/checkout@v4

      # ========================================
      # Step 2: Setup Node.js
      # ========================================
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # ========================================
      # Step 3: Verify FTP Secrets
      # ========================================
      - name: üîç Verify FTP Secrets
        env:
          FTP_SERVER: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
        run: |
          echo "=== Verifying FTP Secrets ==="
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::One or more FTP secrets are missing!"
            echo "Required secrets:"
            echo "  - CPANEL_FTP_SERVER (or FTP_SERVER)"
            echo "  - CPANEL_FTP_USER (or FTP_USERNAME)"
            echo "  - CPANEL_FTP_PASS (or FTP_PASSWORD)"
            echo "Optional:"
            echo "  - CPANEL_FTP_PORT (default: 21)"
            echo "  - CPANEL_FTP_DIR (default: public_html/myapp)"
            exit 1
          fi
          echo "‚úÖ FTP secrets verified"
          echo "FTP_SERVER length: ${#FTP_SERVER}"
          echo "FTP_USERNAME length: ${#FTP_USERNAME}"
          echo "FTP_PASSWORD length: ${#FTP_PASSWORD}"

      # ========================================
      # Step 4: Install Dependencies
      # ========================================
      - name: üì¶ Install dependencies
        run: |
          echo "Installing production dependencies..."
          # Use npm install instead of npm ci to handle lock file sync issues
          npm install --omit=dev --legacy-peer-deps
          npm cache clean --force
          echo "‚úÖ Dependencies installed"

      # ========================================
      # Step 5: Clean Build Artifacts & Old Files
      # ========================================
      - name: üßπ Clean unnecessary files before deployment
        run: |
          echo "üßπ Cleaning build artifacts and old files..."
          
          # Remove large directories that shouldn't be deployed
          echo "Removing node_modules..."
          rm -rf node_modules
          
          # Remove version control
          echo "Removing .git and .github..."
          rm -rf .git .github
          
          # Remove logs and temp files
          echo "Removing logs and temp files..."
          rm -rf logs tmp .tmp
          find . -type f -name "*.log" -delete
          find . -type f -name "*.tmp" -delete
          
          # Remove test files
          echo "Removing test files..."
          find . -type f -name "test-*.js" -delete
          find . -type f -name "*.test.js" -delete
          find . -type f -name "*.spec.js" -delete
          
          # Remove monitoring/debug scripts
          echo "Removing debug scripts..."
          find . -type f -name "monitor-*.js" -delete
          find . -type f -name "quick-*.js" -delete
          find . -type f -name "run-*.js" -delete
          
          # Remove documentation
          echo "Removing documentation files..."
          find . -type f -name "*.md" -delete
          
          # Remove archives
          echo "Removing archive files..."
          find . -type f -name "*.zip" -delete
          find . -type f -name "*.tar.gz" -delete
          
          # Remove environment files (use cPanel env vars instead)
          echo "Removing environment files..."
          find . -type f -name "config.env" -delete
          find . -type f -name ".env*" -delete
          find . -type f -name "*.env" -delete
          
          # Remove scripts folder (not needed in production)
          echo "Removing scripts folder..."
          rm -rf scripts
          
          # Calculate size after cleaning
          CLEAN_SIZE=$(du -sh . | cut -f1)
          echo "üì¶ Size after cleaning: $CLEAN_SIZE"
          echo "‚úÖ Cleaning complete"

      # ========================================
      # Step 6: Prepare Deployment Package
      # ========================================
      - name: üßπ Prepare deployment package (minimal size)
        run: |
          echo "Preparing minimal deployment package..."
          rm -rf deployment
          mkdir -p deployment

          # Copy essential files only to minimize deployment size
          # This reduces deployment from ~100MB to ~5-10MB
          rsync -av \
                    --exclude='node_modules' \
                    --exclude='.git' \
                    --exclude='test' \
                    --exclude='.github/workflows' \
                    --exclude='deployment' \
                    --exclude='config.env' \
                    --exclude='*.env' \
                    --exclude='.env*' \
                    --exclude='*.log' \
                    --exclude='*.md' \
                    --exclude='**/*.md' \
                    --exclude='test-*.js' \
                    --exclude='quick-*.js' \
                    --exclude='monitor-*.js' \
                    --exclude='run-*.js' \
                    --exclude='*.sh' \
                    --exclude='Archive.zip' \
                    --exclude='production-run.log' \
                    --exclude='memory-monitor-report.json' \
                    --exclude='scripts' \
                    --exclude='.gitignore' \
                    --exclude='README.md' \
                    --exclude='tmp' \
                    --exclude='logs' \
                    ./ ./deployment/

          # CRITICAL: Copy start.sh separately (was excluded by *.sh pattern)
          cp start.sh deployment/start.sh
          chmod +x deployment/start.sh
          
          # CRITICAL: Ensure .github/scripts directory exists for verification script
          # (Note: The script runs BEFORE deployment, so it needs to be available in the runner)
          # We don't deploy .github/scripts, but we need it during the workflow
          
          # Calculate deployment size
          DEPLOY_SIZE=$(du -sh deployment | cut -f1)
          echo "üì¶ Deployment package size: $DEPLOY_SIZE"
          echo ""
          echo "üì¶ Essential files included:"
          ls -la deployment/ | grep -E "(start.sh|server.js|app.js|package.json)" || echo "  Checking..."
          echo ""
          echo "‚úÖ Verifying critical files:"
          [ -f "deployment/start.sh" ] && echo "  ‚úÖ start.sh" || echo "  ‚ùå start.sh MISSING!"
          [ -f "deployment/server.js" ] && echo "  ‚úÖ server.js" || echo "  ‚ùå server.js MISSING!"
          [ -f "deployment/package.json" ] && echo "  ‚úÖ package.json" || echo "  ‚ùå package.json MISSING!"
          [ ! -f "deployment/config.env" ] && echo "  ‚úÖ config.env excluded (good)" || echo "  ‚ö†Ô∏è  config.env included (should be excluded!)"

      # ========================================
      # Step 7: Verify Remote FTP Directories
      # ========================================
      # This step prevents "FTPError: 553 Can't open that file" by ensuring
      # all required directories exist on the remote server before deployment.
      # The script checks and creates missing folders like /controllers, /models, etc.
      - name: üß± Verify remote directories exist
        run: |
          echo "Installing basic-ftp for directory verification..."
          npm install basic-ftp --no-save
          echo "‚úÖ basic-ftp installed"
          echo ""
          echo "Running FTP directory verification script..."
          node .github/scripts/checkFtpDirs.js
        env:
          FTP_SERVER: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          FTP_PORT: ${{ secrets.CPANEL_FTP_PORT || '21' }}

      # ========================================
      # Step 8: Deploy via FTP (with retry)
      # ========================================
      - name: üì§ Deploy to cPanel via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          port: ${{ secrets.CPANEL_FTP_PORT || 21 }}
          local-dir: ./deployment/
          server-dir: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          exclude: |
            node_modules/**
            test/**
            .git*
            .github/**
            deployment/**
            config.env
            *.env
            .env*
            *.log
            *.md
            **/*.md
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            *.sh
            !start.sh
            Archive.zip
            production-run.log
            memory-monitor-report.json
            scripts/**
            .gitignore
            README.md
            tmp/**
            logs/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 60000
          dry-run: false

      # ========================================
      # Step 9: Retry on Failure (552 Disk Full)
      # ========================================
      - name: üîÑ Retry deployment on failure
        if: failure() && steps.ftp-deploy.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}
          port: ${{ secrets.CPANEL_FTP_PORT || 21 }}
          local-dir: ./deployment/
          server-dir: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}
          exclude: |
            node_modules/**
            test/**
            .git*
            .github/**
            deployment/**
            config.env
            *.env
            .env*
            *.log
            *.md
            **/*.md
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            *.sh
            !start.sh
            Archive.zip
            production-run.log
            memory-monitor-report.json
            scripts/**
            .gitignore
            README.md
            tmp/**
            logs/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 60000

      # ========================================
      # Step 10: Post-Deployment Instructions
      # ========================================
      - name: üìã Deployment Summary
        if: success()
        run: |
          echo ""
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "======================================"
          echo "üåê Application deployed to: ${{ secrets.CPANEL_FTP_DIR || 'public_html/myapp/' }}"
          echo "üîó Live URL: https://benzflex.com"
          echo ""
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo "  1. ‚úÖ Set start.sh permissions to 755 in cPanel File Manager"
          echo "  2. ‚úÖ Verify cPanel Node.js App 'Startup File' = start.sh"
          echo "  3. ‚úÖ Verify NODE_OPTIONS env var = --max-old-space-size=3072 --expose-gc"
          echo "  4. ‚úÖ Verify all environment variables are set in cPanel"
          echo "  5. ‚úÖ Install dependencies: npm install --production (on server)"
          echo "  6. ‚úÖ Restart Node.js app in cPanel"
          echo "  7. ‚úÖ Check logs for 'Server running' message"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: config.env was NOT deployed (use cPanel environment variables)"

      # ========================================
      # Step 11: Handle Upload Errors
      # ========================================
      - name: üß† Handle upload errors
        if: failure()
        run: |
          echo "‚ö†Ô∏è FTP upload failed!"
          echo ""
          echo "Common causes:"
          echo "  1. Disk full (552 error) - Clean up server or reduce deployment size"
          echo "  2. FTP credentials incorrect - Verify secrets in GitHub"
          echo "  3. Server directory doesn't exist - Check CPANEL_FTP_DIR secret"
          echo "  4. Network timeout - Check server connectivity"
          echo ""
          echo "Solutions:"
          echo "  - Clean up disk space on server"
          echo "  - Verify FTP credentials in GitHub Secrets"
          echo "  - Check server directory path"
          echo "  - Wait a few minutes and retry manually"
          exit 1
