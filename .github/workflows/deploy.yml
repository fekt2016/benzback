name: üöÄ FTP Deployment for Express Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: üéâ Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: server
      url: https://benzflex.com

    steps:
      - name: üöö Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: üîç Debug FTP Secrets
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "=== Debugging FTP Secrets ==="
          echo "FTP_SERVER length: ${#FTP_SERVER}"
          echo "FTP_USERNAME length: ${#FTP_USERNAME}"
          echo "FTP_PASSWORD length: ${#FTP_PASSWORD}"
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::One or more FTP secrets are missing!"
            exit 1
          fi
          echo "‚úÖ FTP secrets verified"

      - name: üì¶ Install dependencies
        run: |
          echo "Installing production dependencies..."
          # Use npm install instead of npm ci to handle lock file sync issues
          # This ensures package-lock.json matches package.json
          npm install --omit=dev --legacy-peer-deps
          npm cache clean --force
          echo "‚úÖ Dependencies installed"

      - name: üßπ Prepare deployment package
        run: |
          echo "Preparing deployment package..."
          rm -rf deployment
          mkdir -p deployment

          # Copy all files except excluded ones
          rsync -av --exclude='node_modules' \
                    --exclude='.git' \
                    --exclude='test' \
                    --exclude='.github' \
                    --exclude='deployment' \
                    --exclude='config.env' \
                    --exclude='*.env' \
                    --exclude='.env*' \
                    --exclude='*.log' \
                    --exclude='*.md' \
                    --exclude='test-*.js' \
                    --exclude='quick-*.js' \
                    --exclude='monitor-*.js' \
                    --exclude='run-*.js' \
                    --exclude='*.sh' \
                    --exclude='Archive.zip' \
                    --exclude='production-run.log' \
                    --exclude='memory-monitor-report.json' \
                    ./ ./deployment/

          # CRITICAL: Copy start.sh separately and ensure it's included
          # start.sh is essential for cPanel CloudLinux LVE memory limits
          cp start.sh deployment/start.sh
          chmod +x deployment/start.sh
          
          echo "üì¶ Deployment package contents:"
          ls -la deployment/ | head -30
          echo ""
          echo "‚úÖ Verifying critical files:"
          [ -f "deployment/start.sh" ] && echo "  ‚úÖ start.sh" || echo "  ‚ùå start.sh MISSING!"
          [ -f "deployment/server.js" ] && echo "  ‚úÖ server.js" || echo "  ‚ùå server.js MISSING!"
          [ -f "deployment/package.json" ] && echo "  ‚úÖ package.json" || echo "  ‚ùå package.json MISSING!"
          [ ! -f "deployment/config.env" ] && echo "  ‚úÖ config.env excluded (good - use cPanel env vars)" || echo "  ‚ö†Ô∏è  config.env included (should be excluded!)"

      - name: üì§ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: public_html/myapp/
          exclude: |
            node_modules/**
            test/**
            .git*
            .github/**
            deployment/**
            config.env
            *.env
            .env*
            *.log
            *.md
            test-*.js
            quick-*.js
            monitor-*.js
            run-*.js
            *.sh
            !start.sh
            Archive.zip
            production-run.log
            memory-monitor-report.json
          dangerous-clean-slate: false
          log-level: verbose

      - name: üîß Set start.sh permissions (via FTP)
        run: |
          echo "‚ö†Ô∏è  Note: start.sh permissions must be set to 755 in cPanel File Manager"
          echo "‚ö†Ô∏è  After deployment, go to cPanel ‚Üí File Manager ‚Üí backend folder"
          echo "‚ö†Ô∏è  Right-click start.sh ‚Üí Change Permissions ‚Üí Set to 755"

      - name: üìã Deployment Summary
        run: |
          echo ""
          echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "======================================"
          echo "üåê Application deployed to: public_html/myapp/"
          echo "üîó Live URL: https://benzflex.com"
          echo ""
          echo "üìã POST-DEPLOYMENT CHECKLIST:"
          echo "  1. ‚úÖ Set start.sh permissions to 755 in cPanel File Manager"
          echo "  2. ‚úÖ Verify cPanel Node.js App 'Startup File' = start.sh"
          echo "  3. ‚úÖ Verify NODE_OPTIONS env var = --max-old-space-size=3072 --expose-gc"
          echo "  4. ‚úÖ Verify all environment variables are set in cPanel"
          echo "  5. ‚úÖ Restart Node.js app in cPanel"
          echo "  6. ‚úÖ Check logs for 'Server running' message"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: config.env was NOT deployed (use cPanel environment variables)"
