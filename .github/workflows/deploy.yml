name: üöÄ Deploy Backend to cPanel

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FTP_DIR_DEFAULT: "public_html/myapp/backend"
  FTP_PORT_DEFAULT: "21"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://benzflex.com

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Verify FTP Secrets
        id: verify-secrets
        run: |
          FTP_SERVER="${{ secrets.CPANEL_FTP_SERVER || secrets.FTP_SERVER }}"
          FTP_USERNAME="${{ secrets.CPANEL_FTP_USER || secrets.FTP_USERNAME }}"
          FTP_PASSWORD="${{ secrets.CPANEL_FTP_PASS || secrets.FTP_PASSWORD }}"
          FTP_DIR="${{ secrets.CPANEL_FTP_DIR || '/public_html/myapp/' }}"
          FTP_PORT="${{ secrets.CPANEL_FTP_PORT || 21 }}"
          
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "::error::Missing required FTP secrets!"
            exit 1
          fi
          
          echo "FTP_SERVER=$FTP_SERVER" >> $GITHUB_ENV
          echo "FTP_USERNAME=$FTP_USERNAME" >> $GITHUB_ENV
          echo "FTP_PASSWORD=$FTP_PASSWORD" >> $GITHUB_ENV
          echo "FTP_DIR=$FTP_DIR" >> $GITHUB_ENV
          echo "FTP_PORT=$FTP_PORT" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm install basic-ftp --no-save --legacy-peer-deps

      - name: Check disk space
        id: check-disk-space
        run: node .github/scripts/checkDiskSpace.js
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_DIR: '/public_html/myapp/'
          FTP_PORT: 21

      - name: Verify directories
        id: verify-dirs
        run: node .github/scripts/checkFtpDirs.js
        env:
          FTP_SERVER: ${{ env.FTP_SERVER }}
          FTP_USERNAME: ${{ env.FTP_USERNAME }}
          FTP_PASSWORD: ${{ env.FTP_PASSWORD }}
          FTP_DIR: /public_html/myapp/
          FTP_PORT: 21

      - name: Clean old files
        id: cleanup-old-files
        continue-on-error: true
        run: node .github/scripts/cleanupOldFiles.js
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_DIR: '/public_html/myapp/'
          FTP_PORT: 21

      - name: Prepare deployment package
        id: prepare-package
        run: |
          set -e
          rm -rf deployment
          mkdir -p deployment
          
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='test' \
            --exclude='tests' \
            --exclude='*.test.js' \
            --exclude='*.spec.js' \
            --exclude='logs' \
            --exclude='*.log' \
            --exclude='*.md' \
            --exclude='config.env' \
            --exclude='*.env' \
            --exclude='.env*' \
            --exclude='tmp' \
            --exclude='temp' \
            --exclude='deployment' \
            --exclude='production-archive' \
            --exclude='production-package' \
            --exclude='test-*.js' \
            --exclude='monitor-*.js' \
            --exclude='run-*.js' \
            --exclude='check-*.js' \
            --exclude='analyze-*.js' \
            --exclude='*.zip' \
            --exclude='*.tar.gz' \
            --exclude='scripts' \
            ./ ./deployment/
          
          cp start.sh deployment/start.sh
          chmod +x deployment/start.sh
          
          if [ ! -f "deployment/server.js" ] || [ ! -f "deployment/app.js" ] || [ ! -f "deployment/package.json" ]; then
            echo "::error::Critical files missing!"
            exit 1
          fi
          
          echo "‚úÖ Deployment package ready"

      - name: Deploy via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          local-dir: /deployment/
          server-dir: ${{ secrets.FTP_DIR }}
          exclude: |
            node_modules/**
            .git/**
            .github/**
            test/**
            tests/**
            *.test.js
            *.spec.js
            logs/**
            *.log
            *.md
            config.env
            *.env
            .env*
            tmp/**
            temp/**
            deployment/**
            production-archive/**
            production-package/**
            test-*.js
            monitor-*.js
            run-*.js
            check-*.js
            analyze-*.js
            *.zip
            *.tar.gz
            scripts/**
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 120000

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Deployed to: ${{ env.FTP_DIR }}"
          echo ""
          echo "Next steps:"
          echo "1. Install dependencies: npm install --production --legacy-peer-deps"
          echo "2. Set environment variables in cPanel"
          echo "3. Set startup file to: start.sh"
          echo "4. Restart Node.js app"

      - name: Error Analysis
        if: failure()
        run: |
          echo "‚ùå Deployment failed"
          echo ""
          echo "Check which step failed:"
          echo "  - Disk space check: ${{ steps.check-disk-space.outcome }}"
          echo "  - Verify directories: ${{ steps.verify-dirs.outcome }}"
          echo "  - Clean old files: ${{ steps.cleanup-old-files.outcome }}"
          echo "  - Prepare package: ${{ steps.prepare-package.outcome }}"
          echo "  - FTP deploy: ${{ steps.ftp-deploy.outcome }}"
          echo ""
          echo "Common issues:"
          echo "  - 552 = Disk full (clean up server)"
          echo "  - 553 = Directory not found"
          echo "  - 530 = Authentication failed"
          echo "  - Check GitHub Secrets are set correctly"
